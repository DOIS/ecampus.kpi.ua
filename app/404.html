'use strict';

/**
 * @ngdoc function
 * @name ecampusApp.controller:VotingCtrl
 * @description
 * # VotingCtrl
 * Controller of the ecampusApp
 */
angular.module('ecampusApp')
    .controller('VotingCtrl', function($scope, $location, Api) {

        $scope.currentUser = null;
        $scope.personsForVote = [];

        function reload() {

            $scope.currentUser = Api.getCurrentUser();

            if (!$scope.currentUser) {
                $location.path("/");
            }

            Api.execute("GET", "Vote/Term/Current").then(function(data) {
                $scope.voteTerm = !!data && data.length > 0 ? data[0] : null;

                if (!$scope.voteTerm) {
                    //Voting is closed
                }

                getAllPersons();
                getAlreadyVotedPersons();

            });

            function getAllPersons() {
                var action = "Vote/Persons/" + $scope.currentUser.id;

                var payload = {
                    page: 1,
                    size: 100,
                    envelope: false
                };

                Api.execute("GET", action, payload).then(function(data) {
                    $scope.personsForVote = data;
                    $scope.$apply();

                    console.log('$scope.personsForVote', $scope.personsForVote);
                });
            }

            function getAlreadyVotedPersons() {

                var action = "Vote/Persons/" + $scope.currentUser.id + "/Voted";

                var payload = {
                    voteTermId: $scope.voteTerm.id,
                    page: 1,
                    size: 100,
                    envelope: false
                };

                Api.execute("GET", action, payload).then(function(data) {
                    $scope.personsAlreadyVoted = data;
                    $scope.$apply();
                    console.log('$scope.personsAlreadyVoted', $scope.personsAlreadyVoted);
                });

            }

            $scope.personVoted = function(person) {
                var result = false;

                if (!!$scope.personsAlreadyVoted) {

                    $scope.personsAlreadyVoted.forEach(function(p) {
                        if (p.employeesId == person.employeesId) {
                            result = true;
                        }
                    });

                }

                return result;
            };

        }

        reload();

    });goog-wm-qt {
        width: 220px;
        height: 20px;
        padding: 5px;
        margin: 5px 10px 0 0;
        box-shadow: inset 0 1px 1px #ccc;
      }

      #goog-wm-sb {
        display: inline-block;
        height: 32px;
        padding: 0 10px;
        margin: 5px 0 0;
        white-space: nowrap;
        cursor: pointer;
        background-color: #f5f5f5;
        background-image: -webkit-linear-gradient(rgba(255,255,255,0), #f1f1f1);
        background-image: -moz-linear-gradient(rgba(255,255,255,0), #f1f1f1);
        background-image: -ms-linear-gradient(rgba(255,255,255,0), #f1f1f1);
        background-image: -o-linear-gradient(rgba(255,255,255,0), #f1f1f1);
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
      }

      #goog-wm-sb:hover,
      #goog-wm-sb:focus {
        border-color: #aaa;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.1);
        background-color: #f8f8f8;
      }

      #goog-wm-qt:hover,
      #goog-wm-qt:focus {
        border-color: #105cb6;
        outline: 0;
        color: #222;
      }

      input::-moz-focus-inner {
        padding: 0;
        border: 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Not found <span>:(</span></h1>
      <p>Sorry, but the page you were trying to view does not exist.</p>
      <p>It looks like this was the result of either:</p>
      <ul>
        <li>a mistyped address</li>
        <li>an out-of-date link</li>
      </ul>
      <script>
        var GOOG_FIXURL_LANG = (navigator.language || '').slice(0,2),GOOG_FIXURL_SITE = location.host;
      </script>
      <script src="//linkhelp.clients.google.com/tbproxy/lh/wm/fixurl.js"></script>
    </div>
  </body>
</html>
